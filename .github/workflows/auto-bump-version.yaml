name: Auto Bump Version on Merge to main

on:
  pull_request:
    types:
      - closed

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Detect if package.json version changed in PR
        id: ver_changed
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr
            });
            const touched = files.some(f => f.filename === 'package.json' && /"version"\s*:/.test(f.patch || ''));
            core.setOutput('changed', touched ? 'true' : 'false');

      - name: Detect if new UI folder added
        id: new_ui_folder
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr
            });

            const addedDirs = new Set();
            for (const f of files) {
              if (f.status === 'added' && f.filename.startsWith('src/shared/ui/')) {
                const parts = f.filename.split('/');
                if (parts.length > 3) {
                  addedDirs.add(parts.slice(0, 4).join('/'));
                }
              }
            }

            core.setOutput('new_ui_folder', addedDirs.size > 0 ? 'true' : 'false');

      - name: Bump version based on PR type
        if: steps.ver_changed.outputs.changed != 'true'
        run: |
          node -e "
            const fs = require('fs');
            const pr_title = process.env.PR_TITLE;
            const is_new_ui = process.env.NEW_UI_FOLDER === 'true';
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const [a, b, c] = pkg.version.split('.').map(Number);
            let new_version;

            if (is_new_ui) {
              new_version = [a + 1, 0, 0].join('.');
            } else if (pr_title.toLowerCase().startsWith('feat')) {
              new_version = [a, b + 1, 0].join('.');
            } else {
              new_version = [a, b, c + 1].join('.');
            }

            pkg.version = new_version;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          NEW_UI_FOLDER: ${{ steps.new_ui_folder.outputs.new_ui_folder }}

      - name: Install dependencies
        run: npm ci

      - name: Sync exports to src/shared/index.ts
        run: |
          node scripts/syncExports.js

      - name: Build package
        run: npm run build

      - name: Create branch and commit
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          BRANCH="bump/$TIMESTAMP"

          git checkout -b "$BRANCH"

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: bump version and sync shared exports"

          git push origin "$BRANCH"

      - name: Create PR
        id: cpr
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const branch = `bump/${timestamp}`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'chore: bump version & sync exports',
              head: branch,
              base: 'main'
            });

            core.setOutput('pr_number', pr.data.number);

      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.cpr.outputs.pr_number }}
            });

      - name: Publish to npm
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
